name: CI Scripts ðŸ§¾ for Web Branches âœ” 

on:
  push:
    branches:
      - web-dev
  pull_request:
    branches:
      - web
      - web-dev

jobs:
  chromatic:
    name: Publish Storybook to Chromatic ðŸ“š
    env:
      GH_PFP_TOKEN: ${{ secrets.GH_PFP_TOKEN }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup node
        uses: actions/setup-node@v2
        with:
          node-version: '20.11.0'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: cd noplus-web && npm i

      - name: Publish to Chromatic
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          workingDir: noplus-web
  StoryBook:
    name: Build StoryBook ðŸ“š
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code ðŸ“¦
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup node ðŸ“¦
        uses: actions/setup-node@v2
        with:
          node-version: '20.11.0'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies ðŸ“¦
        run: cd noplus-web && npm i

      - name: Build Storybook ðŸ“š
        run: cd noplus-web && npm run build-storybook

      - name: Send Build to Upload Authority
        uses: actions/upload-artifact@v2
        with:
          name: storybook
          path: noplus-web/storybook-static

  StoryDocs:
    name: Build StoryDocs ðŸ“š
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code ðŸ“¦
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup node ðŸ“¦
        uses: actions/setup-node@v2
        with:
          node-version: '20.11.0'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies ðŸ“¦
        run: cd noplus-web && npm i

      - name: Build StoryDocs ðŸ“š
        run: cd noplus-web && npm run build-storydocs

      - name: Send Build to Upload Authority
        uses: actions/upload-artifact@v2
        with:
          name: storydocs
          path: noplus-web/storybook-static

  upstream:
    name: Upload Authority ðŸ“¦
    runs-on: ubuntu-latest
    needs: [StoryBook, StoryDocs]
    steps:
      - name: Checkout code ðŸ“¦
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download Storybook ðŸ“š
        uses: actions/download-artifact@v2
        with:
          name: storybook
          path: docs/storybook

      - name: Download StoryDocs ðŸ“š
        uses: actions/download-artifact@v2
        with:
          name: storydocs
          path: noplus-web/public/storydocs

      - name: Activate Vercel Deployment
        run: |
          echo '{"github": {"enabled": true}}' > vercel.json

      - name: Commit Changes ðŸ“¦
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add vercel.json
          git add noplus-web/public/storydocs
          git add docs/storybook
          git commit -m "Deploy Storybook and StoryDocs to Vercel ðŸ“š"

      - name: Push to Current Branch ðŸ“¦
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}